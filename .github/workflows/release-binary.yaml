name: Release Binary

on:
  release:
    types: [ published ]
  workflow_dispatch:

concurrency:
  group: release-binary-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.platform }}-${{ matrix.architecture }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            architecture: x64
            archiveName: fln-linux-x64.tar.gz
            packageType: tar
            targetName: bun-linux-x64
            outputName: fln
          - os: ubuntu-24.04-arm
            platform: linux
            architecture: arm64
            archiveName: fln-linux-arm64.tar.gz
            packageType: tar
            targetName: bun-linux-arm64
            outputName: fln
          - os: macos-15-intel
            platform: macos
            architecture: x64
            archiveName: fln-macos-x64.tar.gz
            packageType: tar
            targetName: bun-darwin-x64
            outputName: fln
          - os: macos-latest
            platform: macos
            architecture: arm64
            archiveName: fln-macos-arm64.tar.gz
            packageType: tar
            targetName: bun-darwin-arm64
            outputName: fln
          - os: windows-latest
            platform: windows
            architecture: x64
            archiveName: fln-windows-x64.zip
            packageType: zip
            targetName: bun-windows-x64
            outputName: fln.exe
          - os: windows-11-arm
            platform: windows
            architecture: arm64
            archiveName: fln-windows-arm64.zip
            packageType: zip
            targetName: bun-windows-x64
            outputName: fln.exe
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate version file
        run: bun run generate:version

      - name: Build binary
        run: bun build --compile --minify --sourcemap ./src/cli/index.ts --outfile "${{ matrix.outputName }}" --target ${{ matrix.targetName }}

      - name: Package binary
        id: package
        shell: bash
        run: |
          binaryName="${{ matrix.outputName }}"
          archive="${{ matrix.archiveName }}"
          
          # Make executable on Unix
          if [[ "${{ runner.os }}" != "Windows" ]]; then
            chmod +x "$binaryName"
          fi
          
          # Create archive
          if [[ "${{ matrix.packageType }}" == "tar" ]]; then
            tar -czf "$archive" "$binaryName"
          else
            if [[ "${{ runner.os }}" == "Windows" ]]; then
              powershell -Command "Compress-Archive -Path '$binaryName' -DestinationPath '$archive'"
            else
              zip -j "$archive" "$binaryName"
            fi
          fi
          
          # Calculate SHA256
          if command -v sha256sum >/dev/null 2>&1; then
            set -- $(sha256sum "$archive")
          elif command -v shasum >/dev/null 2>&1; then
            set -- $(shasum -a 256 "$archive")
          else
            # Windows fallback
            hash=$(powershell -Command "(Get-FileHash -Algorithm SHA256 '$archive').Hash.ToLower()")
            set -- $hash
          fi
          
          hash="$1"
          echo "$hash  $archive" > "${archive}.sha256"
          echo "archivePath=$archive" >> "$GITHUB_OUTPUT"
          echo "checksumPath=${archive}.sha256" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: fln-${{ matrix.platform }}-${{ matrix.architecture }}
          path: |
            ${{ steps.package.outputs.archivePath }}
            ${{ steps.package.outputs.checksumPath }}

  release:
    name: Upload to Release
    needs: build
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: fln-*
          merge-multiple: true

      - name: List release assets
        id: assets
        run: |
          echo "assets<<EOF" >> "$GITHUB_OUTPUT"
          find . -maxdepth 1 -type f -name 'fln-*' | sed 's|^\./||' | sort >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create/update release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.assets.outputs.assets }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
